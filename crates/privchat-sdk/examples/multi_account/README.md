# PrivChat 多账号协作测试项目

这是一个完整的多账号协作测试项目，用于验证 PrivChat SDK 在多用户场景下的功能完整性和稳定性。

## 🔐 认证说明

本测试项目使用真实的 JWT Token 进行认证，完全适配服务器端的认证系统。

- ✅ **自动生成 JWT** - 使用内置的 Mock JWT 生成器
- ✅ **与服务器完全兼容** - 使用相同的密钥和算法（HS256）
- ✅ **零配置运行** - 开箱即用，无需额外设置
- ✅ **支持设备管理** - 每个用户自动获得唯一的设备ID

## 🎯 测试目标

该项目通过模拟三个用户（Alice、Bob、Charlie）的并发操作，全面测试：

- 🔐 **多账号并发认证** - 验证多个用户同时登录的能力
- 💬 **跨账号私聊消息** - 验证用户间的点对点消息通信
- 🔧 **RPC 业务接口** - 验证用户查找、群组管理等业务功能
- 👥 **群组协作功能** - 验证群组消息广播和成员管理
- 🌟 **复杂并发场景** - 验证系统在复杂交互下的稳定性
- 📦 **表情包管理** - 验证表情包库查询和使用功能（新增）
- 💬 **会话列表和置顶** - 验证会话管理和置顶功能（新增）
- ✔️ **已读回执** - 验证消息已读状态同步功能（新增）
- 📁 **文件上传** - 验证文件上传Token和流程（新增）
- 📴 **离线消息推送** - 验证事件驱动的离线消息推送机制
- 📋 **历史消息获取** - 验证消息历史查询和分页功能
- 🔄 **pts 同步机制** - 验证 Telegram 风格的消息同步指针（最新）⭐
- 📊 **离线消息队列限制** - 验证 100 条队列上限和消息丢弃机制（最新）⭐
- 👑 **高级群组管理** - 验证角色转让、禁言、全员禁言、QR 码等功能（最新）⭐

## 📁 项目结构

```
multi_account/
├── src/
│   ├── main.rs                  # 程序入口
│   ├── account_manager.rs       # 多账号管理器
│   ├── test_coordinator.rs      # 测试协调器
│   ├── realistic_test_phases.rs # 测试阶段实现
│   ├── event_system.rs          # 事件系统
│   ├── mock_jwt.rs              # Mock JWT 生成器
│   └── types.rs                 # 类型定义
├── Cargo.toml                   # 项目配置
└── README.md                    # 项目文档
```

## 🏗️ 架构设计

### 核心组件

1. **MultiAccountManager** - 管理多个 PrivchatClient 实例
   - 独立的数据目录：`./demo_data_multi/{user}/`
   - 独立的网络连接和会话管理
   - 统一的消息发送和 RPC 调用接口

2. **EventBus** - 统一的事件处理系统
   - 跨账号的消息和事件路由
   - 实时的事件统计和追踪
   - 完整的事件历史记录

3. **TestCoordinator** - 测试执行协调器
   - 分阶段的测试执行流程
   - 自动重试和错误处理机制
   - 详细的测试报告生成

4. **TestPhases** - 具体测试场景实现
   - 模块化的测试阶段设计
   - 完整的指标收集和验证
   - 灵活的测试配置支持

## 🚀 运行方式

### 前置条件

确保 PrivChat 服务器正在运行：
```bash
# 在 privchat-server 目录下
cargo run --bin privchat-server
```

### 运行测试

```bash
# 在当前目录下
cargo run
```

或者使用详细日志：
```bash
RUST_LOG=debug cargo run
```

## 📊 测试流程

### Phase 1: 并发认证测试
- Alice、Bob、Charlie 三个账号同时连接
- 验证多用户认证和会话管理
- 检查所有账号的在线状态

### Phase 2: 交叉私聊测试
- Alice ↔ Bob 私聊对话
- Alice ↔ Charlie 私聊对话  
- Bob ↔ Charlie 私聊对话
- 验证消息路由和频道自动创建

### Phase 3: RPC 功能测试
- 用户查找功能测试
- 群组创建功能测试
- 好友申请功能测试（预期部分失败）
- 验证 RPC 调用的成功率和错误处理

### Phase 4: 群组协作测试
- 群组消息发送和接收
- 多成员并发参与讨论
- 验证消息广播机制

### Phase 5: 消息接收验证
- 验证私聊消息的接收
- 验证群组消息的广播接收
- 统计消息收发情况

### Phase 6: 表情包功能测试 ⭐ 新增
- 获取表情包库列表
- 查询表情包库详情
- 验证表情包数据结构
- 测试多个账号同时使用表情包

### Phase 7: 会话列表和置顶 ⭐ 新增
- 获取用户的所有会话列表
- 验证会话排序（置顶优先+时间倒序）
- 测试会话置顶功能
- 验证未读消息数统计
- 检查最后消息预览

### Phase 8: 已读回执测试 ⭐ 新增
- Alice 发送消息给 Bob
- Bob 标记消息已读
- Alice 查询已读状态
- 测试群组已读回执
- 验证群组已读列表和统计

### Phase 9: 文件上传流程 ⭐ 新增
- 请求文件上传 Token
- 验证 Token 和上传 URL 返回
- 测试不同文件类型（图片、视频）
- 验证 Token 过期机制

### Phase 10: 其他消息类型测试
- 位置消息发送和接收
- 名片消息发送和接收
- 验证不同消息类型的 metadata 结构

### Phase 11: 消息历史查询测试
- 测试历史消息获取接口
- 验证分页和排序功能
- 跳过服务端消息搜索（客户端本地实现）

### Phase 12: 消息撤回功能测试
- 私聊消息撤回测试（2分钟时限）
- 群聊消息撤回测试
- 验证撤回权限和时间限制

### Phase 13: 离线消息推送测试
- Alice 在线接收消息验证
- Alice 断开连接（模拟离线）
- Bob 和 Charlie 发送离线消息
- Alice 重新连接
- 验证离线消息批量推送（事件驱动模式）
- 测试历史消息获取接口
- 验证消息顺序和完整性

### Phase 14: pts 同步和离线消息队列限制测试 🆕
- 获取 Alice 的初始 pts
- Alice 断开连接
- Bob 发送 150 条离线消息
- 验证 **100 条队列限制**⭐
- Alice 重新连接，检查 pts 同步
- 验证最多收到 100 条最新消息
- 验证未读计数准确性

### Phase 15: 高级群组功能测试 👑 最新
- 设置管理员（Alice → Bob）
- 禁言功能测试（Bob 禁言 Charlie）
- 解除禁言验证
- 全员禁言测试（管理员/群主豁免）⭐
- 群设置管理（审批、邀请权限等）
- QR 码加群流程
- 转让群主（Alice → Bob）

## 📈 测试报告

测试完成后会生成详细报告，包括：

- **总体统计** - 执行时间、成功率、错误统计
- **通信统计** - 消息发送量、RPC调用成功率
- **阶段详情** - 每个测试阶段的执行结果
- **账号状态** - 所有账号的连接和会话状态
- **事件统计** - 完整的事件处理统计
- **功能验证** - 各项功能的验证结果

## 🎯 预期结果

正常情况下，测试应该达到（共15个测试阶段）：
- ✅ Phase 1-5（基础功能）：成功率 ≥80%
- ✅ Phase 6-9（用户体验功能）：成功率 ≥90%
- ✅ Phase 10-13（高级功能）：成功率 ≥85%
- ✅ Phase 14（pts 同步和队列限制）：成功率 ≥90%⭐
- ✅ Phase 15（高级群组功能）：成功率 ≥85%⭐
- ✅ 认证成功率：100%
- ✅ 消息发送成功率：100% 
- ✅ RPC调用成功率：≥70%（部分模块可能未启用）
- ✅ 新功能 RPC 成功率：≥80%（表情包、会话、已读、文件）
- ✅ 离线消息推送：收到率 ≥90%
- ✅ 群组权限管理：验证率 100%⭐
- ✅ 总体成功率：≥85%

## 🛠️ 配置选项

可以通过修改 `TestConfig` 来调整测试参数：

```rust
TestConfig {
    phase_delay: Duration::from_millis(500),    // 阶段间延迟
    message_delay: Duration::from_millis(100),  // 消息间延迟
    rpc_timeout: Duration::from_secs(5),        // RPC超时时间
    max_retries: 3,                             // 最大重试次数
}
```

## 🔍 故障排查

### 常见问题

1. **服务器连接失败**
   - 确保 privchat-server 正在运行
   - 检查端口 8080, 8081, 8082 是否可用

2. **认证失败**
   - 检查服务器日志确认认证逻辑
   - 验证 mock 用户数据是否正确初始化

3. **RPC调用失败**
   - 某些模块可能未启用（如 contact、message）
   - 这是预期行为，不影响核心功能测试

4. **消息发送失败**
   - 检查频道创建和权限验证逻辑
   - 查看服务器端的处理日志

### 调试模式

使用详细日志运行：
```bash
RUST_LOG=trace cargo run
```

这将显示所有网络通信、事件处理和错误详情。

## 🎉 项目价值

这个多账号测试项目展示了：

1. **架构的正确性** - 验证了 SDK 支持真正的多账号并发
2. **功能的完整性** - 涵盖了所有核心功能的端到端测试
3. **代码的可维护性** - 模块化设计便于扩展和维护
4. **测试的专业性** - 完整的测试流程和报告机制

它证明了 PrivChat 系统具备企业级的多用户协作能力！